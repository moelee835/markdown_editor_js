<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Markdown Editor & Viewer</title>
<link rel="icon" href=".\static\img\markdown.PNG" type="image/x-icon" />
<style>
  /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
  html, body {
    height: 100%;
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
  }
  #toolbar {
    background: #2d2d2d;
    color: white;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  #toolbar > * {
    cursor: pointer;
  }
  #container {
    flex: 1;
    display: flex;
    height: calc(100% - 40px);
    overflow: hidden;
  }
  #editor, #preview {
    height: 100%;
    box-sizing: border-box;
    padding: 12px;
    border: 1px solid #ccc;
    overflow: auto;
  }
  #editor {
    width: 50%;
    font-family: Consolas, Monaco, monospace;
    font-size: 16px;
    resize: none;
    outline: none;
  }
  #preview {
    width: 50%;
    background: white;
  }
  #preview.fullscreen {
    position: fixed;
    top: 91px; left: 0; right: 0; bottom: 0;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999;
    border: none;
    padding: 20px;
    overflow-y: auto;
    background: white;
  }
  button {
    background: #5a9bd4;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 3px;
    font-size: 14px;
  }
  button:active {
    background: #427ab3;
  }
  
  .backBtn {
      opacity: 0.5;
      display: none;
      height: 50px;
      width: 80px;
      position: absolute;
      z-index : 9999;
      top:90%;
      right:5%;
      background: #FF0000;
  }
  input[type=file] {
    display: none;
  }
  label[for=fileInput] {
    background: #5a9bd4;
    color: white;
    padding: 6px 12px;
    border-radius: 3px;
    font-size: 14px;
    cursor: pointer;
    user-select: none;
  }
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
  }
</style>
</head>
<body>

<div id="toolbar">
  <label for="fileInput" title=".md íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</label>
  <input type="file" id="fileInput" accept=".md,text/markdown,text/plain" />
  <button id="saveBtn" title="í˜„ì¬ ë§ˆí¬ë‹¤ìš´ ì €ì¥í•˜ê¸°">ğŸ’¾ ì €ì¥</button>
  <button id="togglePreviewBtn" title="ë¯¸ë¦¬ë³´ê¸° ì „ì²´í™”ë©´ ì „í™˜">ğŸ” ì „ì²´í™”ë©´</button>
  <!-- <button id="saveAsPdfBtn" title="pdfë¡œ ë‹¤ìš´ë¡œë“œ">ğŸ“•PDFë¡œ ì €ì¥</button> -->
</div>

<div id="container">
  <textarea id="editor" spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="Markdown í…ìŠ¤íŠ¸ë¥¼ ì—¬ê¸°ì— ì‘ì„±í•˜ì„¸ìš”..."></textarea>
  <div id="preview" aria-live="polite" aria-label="Markdown ë¯¸ë¦¬ë³´ê¸°"></div>
</div>

<!-- marked.min.js - CDN -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(() => {
  const editor = document.getElementById("editor");
  const preview = document.getElementById("preview");
  const fileInput = document.getElementById("fileInput");
  const saveBtn = document.getElementById("saveBtn");
  const togglePreviewBtn = document.getElementById("togglePreviewBtn");

  const isFileSystemAccessAPISupported = 'showSaveFilePicker' in window;
  //let filename = `markdown-${new Date().toISOString().slice(0,10)}.md`; -> ì´ íŒŒì¼ëª…ì„ ì‚¬ìš©í•  ì¼ ì—†ìŒ.
  let filename = null;
  
  //const saveAsPdfBtn = document.getElementById("saveAsPdfBtn");
  
  // ê¸°ë³¸ ë§ˆí¬ë‹¤ìš´ ìƒ˜í”Œ í…ìŠ¤íŠ¸
  const defaultMd = `# Markdown Editor & Viewer

- ì™¼ìª½ì— ë§ˆí¬ë‹¤ìš´ ì…ë ¥
- ì˜¤ë¥¸ìª½ì— ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
- íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ë° ì €ì¥ ê°€ëŠ¥
- ë¯¸ë¦¬ë³´ê¸° ì „ì²´í™”ë©´ í† ê¸€

---

## ì‚¬ìš©ë²•

1. Markdownì„ ì…ë ¥í•˜ì„¸ìš”.
2. ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ìœ¼ë¡œ .md íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. ğŸ’¾ ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ ì‘ì„±í•œ ë‚´ìš©ì„ .md íŒŒì¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
4. ğŸ” ì „ì²´í™”ë©´ ë²„íŠ¼ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¸Œë¼ìš°ì € ì „ì²´ í™”ë©´ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

> íšŒì˜ ê¸°ë¡ ë˜ëŠ” ë©”ëª¨ ì‘ì„±ì‹œ ë”ìš± í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ì„¸ìš”!`;

  // ë§ˆí¬ë‹¤ìš´ -> HTML ì‹¤ì‹œê°„ ë³€í™˜  
  function refreshPreview() {
    const mdText = editor.value;
    try {
      const html = marked.parse(mdText, { breaks: true, gfm: true });
      preview.innerHTML = html;
    } catch(e) {
      preview.textContent = "Markdown ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      console.error(e);
    }
  }

  // ë³€ê²½ ê°ì§€ì‹œ preview ê°±ì‹  (ë””ë°”ìš´ì‹±)
  let debounceTimer = null;
  editor.addEventListener("input", () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(refreshPreview, 150);
  });

  // íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (.md ë§Œ í—ˆìš©)
  fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    // fileëª…ì„ ë¯¸ë¦¬ ì €ì¥í•œë‹¤.
    if (!file) return;
  	filename = file.name
    console.log("í˜„ì¬ íŒŒì¼ëª… : "+filename);
  	if (!file.name.endsWith(".md")) {
      alert(".md í™•ì¥ì íŒŒì¼ë§Œ ì„ íƒí•˜ì„¸ìš”.");
      fileInput.value = "";
      return;
    }
    const reader = new FileReader();
    reader.onload = function(evt) {
      editor.value = evt.target.result;
      refreshPreview();
      fileInput.value = "";
    };
    reader.readAsText(file);
  });

  async function saveMarkdownWithPicker(content, suggestedName) {
  console.log("í”¼ì»¤ ì‹¤í–‰ë¨");
  if(suggestedName == null) {
  	suggestedName = `md-${new Date().toISOString().slice(0, 10)}.md`;
  	console.log("íŒŒì¼ëª…ì´ nullì´ë¼ ë‹¤ìŒìœ¼ë¡œ ì„¤ì •ë¨. : " + suggestedName);
  }
  
  if (!isFileSystemAccessAPISupported) {
    alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê³ ê¸‰ ì €ì¥ ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•Šì•„ ê¸°ë³¸ ë‹¤ìš´ë¡œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
    return fallbackDownload(content, suggestedName);
  }

  try {
    const options = {
      types: [{
        description: 'Markdown íŒŒì¼',
        accept: { 'text/markdown': ['.md'] },
      }],
      suggestedName,
    };
    const handle = await window.showSaveFilePicker(options);
    const writable = await handle.createWritable();
    await writable.write(content);
    const file = await handle.getFile();
    const fileActualName = file.name;
    alert("íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ : " + fileActualName);
    
    await writable.close();
    	
    return fileActualName;
  } catch (e) {
    if (e.name !== 'AbortError') {
      alert("íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
    // ì €ì¥ ì·¨ì†Œì‹œ ë³„ë„ ì²˜ë¦¬ ì—†ìŒ
  }
}

// í´ë°± ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œ)
function fallbackDownload(content, filename) {
  const blob = new Blob([content], { type: "text/markdown;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
  return filename;
}

  // ì‘ì„±ì¤‘ ë‚´ìš© ì €ì¥í•˜ê¸° (.md íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ)
  saveBtn.addEventListener("click", async () => {
  const text = editor.value;
  if (!filename) {
    filename = `markdown-${new Date().toISOString().slice(0, 10)}.md`;
  }
  filename = await saveMarkdownWithPicker(text, filename);
  console.log(filename);
  });
    
  const togglePreview = () => {
    if (preview.classList.contains("fullscreen")) {
      preview.classList.remove("fullscreen");
      // container ë‚´ë¶€ ë¹„ìœ¨ ì›ë³µ
      editor.style.display = "block";
      editor.style.width = "50%";
      preview.style.width = "50%";
      togglePreviewBtn.textContent = "ğŸ” ì „ì²´í™”ë©´";
    } else {
      preview.classList.add("fullscreen");
      // ì—ë””í„° ê°ì¶”ê¸°
      editor.style.display = "none";
      preview.style.width = "100%";
      togglePreviewBtn.textContent = "âŒëŒì•„ê°€ê¸°"
    }
  }
  // ë¯¸ë¦¬ë³´ê¸° ì „ì²´í™”ë©´ í† ê¸€
  togglePreviewBtn.addEventListener("click", togglePreview);
  // ì´ˆê¸°ê°’ ì…‹íŒ… & ë Œë”ë§
  editor.value = defaultMd;
  refreshPreview();

  function saveWithKey(event) {
    // í‚¤ ì €ì¥ ê¸°ëŠ¥ í™œì„±í™”.
    if(event.ctrlKey && (event.key === 's' || event.key ==='S')) {
     	if(filename == null) filename = `markdown-${new Date().toISOString().slice(0,10)}.md`;
 		fallbackDownload(editor.value, filename);
      event.stopPropagation();
      event.preventDefault();
    }
  }  
  
  editor.addEventListener("keydown", saveWithKey); 
  
})();
</script>

</body>
</html>
